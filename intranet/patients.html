<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Patients - Roblox Health Service</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../assets/css/nhsuk.min.css">
<style>
table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
th, td { border: 1px solid #d0d0d0; padding: 0.5rem; text-align: left; }
th { cursor: pointer; background: #f7f7f7; }
.nhsuk-button { margin-right: 0.5rem; margin-bottom: 0.25rem; }
.badge { padding: 0.25rem 0.5rem; border-radius: 4px; color: white; font-weight: bold; }
.Stable { background-color: green; }
.Critical { background-color: red; }
.Recovering { background-color: orange; }
tr.Critical { background-color: #ffe5e5; }
tr.Recovering { background-color: #fff3e0; }
tr.Stable { background-color: #e5ffe5; }
.pagination { margin-top: 1rem; }
.pagination button { margin-right: 0.25rem; }
</style>
</head>
<body class="nhsuk-body nhsuk-clearfix">

<header class="nhsuk-header">
  <div class="nhsuk-width-container nhsuk-header__container">
    <span class="nhsuk-header__logo-text">Roblox Health Service</span>
    <nav class="nhsuk-header__navigation" aria-label="Primary navigation">
      <ul class="nhsuk-header__navigation-list">
        <li class="nhsuk-header__navigation-item"><a class="nhsuk-header__navigation-link" href="dashboard.html">Dashboard</a></li>
        <li class="nhsuk-header__navigation-item"><a class="nhsuk-header__navigation-link" href="patients.html">Patients</a></li>
        <li class="nhsuk-header__navigation-item"><a class="nhsuk-header__navigation-link" href="add-patient.html">Add Patient</a></li>
        <li class="nhsuk-header__navigation-item"><a class="nhsuk-header__navigation-link" href="login.html">Logout</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="nhsuk-width-container">
<main class="nhsuk-main-wrapper">

<h1 class="nhsuk-heading-xl">Patient List</h1>

<label class="nhsuk-label" for="search">Search Patients</label>
<input class="nhsuk-input" id="search" placeholder="Search by name...">
<button class="nhsuk-button nhsuk-button--secondary" id="exportCSV">Export CSV</button>

<table>
  <thead>
    <tr>
      <th onclick="sortTable('name')">Name</th>
      <th onclick="sortTable('room')">Room</th>
      <th onclick="sortTable('presenting')">Presenting Condition</th>
      <th onclick="sortTable('diagnosis')">Diagnosis</th>
      <th onclick="sortTable('status')">Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="patientBody"></tbody>
</table>

<div class="pagination" id="pagination"></div>

<script>
let patients = JSON.parse(localStorage.getItem('patients')||'[]');
let sortAsc = true;
let currentSort = 'status';
let searchFilter = '';
let currentPage = 1;
const rowsPerPage = 5;

function savePatients() {
  localStorage.setItem('patients', JSON.stringify(patients));
  renderTable();
}

function renderTable(){
  const tableBody = document.getElementById('patientBody');
  tableBody.innerHTML='';
  let filtered = patients.filter(p=>p.name.toLowerCase().includes(searchFilter.toLowerCase()));

  // Critical on top if sorting by status
  if(currentSort==='status'){
    filtered.sort((a,b)=>{
      const order={'Critical':0,'Recovering':1,'Stable':2};
      return order[a.status]-order[b.status];
    });
  } else {
    filtered.sort((a,b)=>{
      if(a[currentSort]<b[currentSort]) return sortAsc?-1:1;
      if(a[currentSort]>b[currentSort]) return sortAsc?1:-1;
      return 0;
    });
  }

  const totalPages = Math.ceil(filtered.length/rowsPerPage);
  if(currentPage>totalPages) currentPage=1;
  const start = (currentPage-1)*rowsPerPage;
  const end = start + rowsPerPage;

  filtered.slice(start,end).forEach((p)=>{
    const tr=document.createElement('tr');
    tr.className=p.status;
    tr.innerHTML=`<td>${p.name}</td>
      <td>${p.room}</td>
      <td>${p.presenting}</td>
      <td>${p.diagnosis}</td>
      <td><span class="badge ${p.status}">${p.status}</span></td>
      <td>
        <a class="nhsuk-button nhsuk-button--secondary" href="edit-patient.html?index=${patients.indexOf(p)}">Edit</a>
        <a class="nhsuk-button nhsuk-button--warning" href="delete-patient.html?index=${patients.indexOf(p)}">Delete</a>
      </td>`;
    tableBody.appendChild(tr);
  });

  // Pagination buttons
  const pagDiv = document.getElementById('pagination');
  pagDiv.innerHTML='';
  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement('button');
    btn.textContent=i;
    btn.className='nhsuk-button nhsuk-button--secondary';
    if(i===currentPage) btn.disabled=true;
    btn.addEventListener('click',()=>{ currentPage=i; renderTable(); });
    pagDiv.appendChild(btn);
  }
}

// Sorting
function sortTable(col){
  if(currentSort===col) sortAsc=!sortAsc;
  else { currentSort=col; sortAsc=true; }
  renderTable();
}

// Search filter
document.getElementById('search').addEventListener('input', function(){
  searchFilter=this.value; currentPage=1; renderTable();
});

// Export CSV
document.getElementById('exportCSV').addEventListener('click', function(){
  let csv='Name,Room,Presenting Condition,Diagnosis,Status\n';
  patients.forEach(p=>{ csv+=`${p.name},${p.room},${p.presenting},${p.diagnosis},${p.status}\n`; });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='patients.csv'; a.click();
  URL.revokeObjectURL(url);
});

// Initial render
renderTable();

// Live updates across tabs/windows
window.addEventListener('storage', function(e){
  if(e.key==='patients'){ patients=JSON.parse(e.newValue||'[]'); renderTable(); }
});

// Live updates in same tab (polling every 2s)
setInterval(()=>{
  const updated = JSON.parse(localStorage.getItem('patients')||'[]');
  if(JSON.stringify(updated)!==JSON.stringify(patients)){
    patients=updated; renderTable();
  }
},2000);
</script>

</main>
</div>

<footer class="nhsuk-footer">
<div class="nhsuk-width-container">
<p class="nhsuk-body-s">Â© Roblox Health Service</p>
</div>
</footer>

</body>
</html>
